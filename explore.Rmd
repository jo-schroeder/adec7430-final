---
title: "Explore the Models"
output: 
  html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  message = FALSE, warning = FALSE, echo = FALSE
)

# loading packages
library(lubridate)
library(dtwclust)
library(ggthemes)
library(ggplot2)
library(plotly)
library(dplyr)
library(tidyr)
library(tsfeatures)
library(tidymodels)
library(purrr)
library(readr)
library(stringr)
library(caret)
library(randomForest)
library(tibble)
library(kableExtra)

# load in data
data_dir <- "./data/"
actors <- read_csv(paste0(data_dir, "actors_features.csv"))
trends <- read_csv(paste0(data_dir, "trends.csv"))

# summary stats
summary(actors)
# Some of the actor info of interest has NA values (15 birthdays, 5 Popularity scores), so we will have to decide what we want to do about those
summary(trends)
# <1 trend needs to be recoded as numeric, I think we should choose 0 
# also the trends were downloaded for actors who were in popular movies in 2025, but they won't be included in the analysis
```

```{r}
# Exploring birth years of actors
actors %>% 
  filter(birth_year >=1920) %>%
  ggplot(aes(x = birth_year, color = factor(nominee))) +
  geom_density() +
  labs(title = "How old are Oscar Nominated and Commercially Successful Actors?",
       subtitle = "Actors nominated for an Oscar or in a commercially successful movie from 2004 - 2024",
       x = "Birth Year",
       y = "Proportion",
       caption = "Data Sources: The Oscar Award, 1927-2025 (aquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API)",
       color = "") +
  scale_color_solarized(labels = c("Non-Nominee", "Nominee")) +
  theme_minimal() +
  guides(color = guide_legend(override.aes = list(fill = c("#268bd2", "#dc322f")))) 

# by gender
actors %>% filter(Gender != "Not set") %>%
  ggplot(aes(x = Gender, fill = factor(nominee))) +
  geom_histogram(stat="count", position = "dodge") +
  labs(title = "What Gender are Oscar Nominated and Commercially Successful Actors?",
       subtitle = "Actors nominated for an Oscar or in a commercially successful movie from 2004 - 2024",
       x = "Gender",
       y = "Count",
       caption = "Data Sources: The Oscar Award, 1927-2025 (aquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API)",
       fill = "") +
  scale_fill_solarized(labels = c("Non-Nominee", "Nominee")) +
  theme_minimal()
# This is sort of interesting- there's 10 male and 10 female actors nominated every year. This suggests that men born after 1975 are less represented in nominations overall, esp. compared to women in the same age group. Dominance of older actors in male categories?

actors %>%
  ggplot(aes(x = american, fill = factor(nominee))) +
  geom_histogram(stat="count", position = "dodge") +
  labs(title = "What Nationality are Oscar Nominated and Commercially Successful Actors?",
       subtitle = "Actors nominated for an Oscar or in a commercially successful movie from 2004 - 2024",
       x = "Nationality",
       y = "Count",
       caption = "Data Sources: The Oscar Award, 1927-2025 (aquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API)",
       fill = "") +
  scale_fill_solarized(labels = c("Non-Nominee", "Nominee")) +
  scale_x_continuous(breaks = c(0, 1), labels = c("Non-American", "American")) +
  theme_minimal()

# exploring age at nomination
actors %>% 
  filter(nominee == 1) %>%
  mutate(min_year = map_dbl(nominated_years, function(s) {
    s %>%
      str_remove_all("\\[|\\]") %>%       
      str_split(",\\s*") %>%              
      unlist() %>%
      as.numeric() %>%
      min(na.rm = TRUE)
  })) %>%
  mutate(age_at_nomination = as.numeric(difftime(min_year, birth_year))) %>%
  filter(age_at_nomination < 100, Gender != "Non-binary/Other") %>%
  ggplot(aes(x = age_at_nomination, color = Gender)) +
  geom_density() +
  labs(title = "At What Age are Oscar Nominated Actors Nominated?",
       subtitle = "Actors nominated for an Oscar from 2004 - 2024",
       x = "",
       y = "Proportion",
       caption = "Data Sources: The Oscar Award, 1927-2025 (aquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API)",
       fill = "") +
  scale_color_solarized(labels = c("Female", "Male", NA)) +
  theme_minimal() +
  guides(color = guide_legend(override.aes = list(fill = c("#268bd2", "#dc322f")))) +
  scale_x_continuous(breaks = c(20, 30, 40, 50, 60, 70, 80))
# Obviously there's an error here - I'll have to go back and check the API call results for the 130 year old but I'm guessing there's another famous person with the same name

```


```{r}
# interactive trends plot
p <- plot_ly(type = "scatter", mode = "lines")

trends <- trends %>%
  mutate(across(everything(), ~ ifelse(. == "<1", 0, .))) %>%
  mutate(across(c("Mark Ruffalo":"Aaron Eckhart"), ~ as.numeric(.))) %>%
  pivot_longer(cols = c("Mark Ruffalo":"Aaron Eckhart")) %>%
  mutate(Month = ym(Month))

trends %>%
  group_by(name) %>%
  group_split() %>%
  purrr::walk(function(df) {
    p <<- add_trace(p,
                    data = df,
                    x = ~Month,
                    y = ~value,
                    name = unique(df$name),
                    text = ~paste(name, value),
                    hoverinfo = "text",
                    visible = "legendonly")
  })

p %>%
  layout(
    title = "Monthly Search Interest for Selected Actors since 2004",
    xaxis = list(title = "Month", range = c("2004-01-01",
                                            "2025-03-01")),
    yaxis = list(title = "Google Trend Search Interest", range = c(0, 100)),
    legend = list(title = list(text = "Select an Actor"))
  )


# joining 
joined <- trends %>% 
  mutate(name = tolower(name)) %>%
  left_join(actors, by = c("name")) %>%
  mutate(type = factor(type, levels = c("commercial", "oscar", "both"),
  labels = c("Commercially Successful", "Oscar Nominated", "Commercially Successful & Oscar Nominated")))

# by winner
joined %>% 
  filter(!is.na(type)) %>%
  group_by(Month, type) %>% summarise(value = mean(value)) %>%
  ggplot(aes(x = Month, y = value, color = type)) +
  geom_line() +
  labs(title = "What are the patterns in Google Trend Search Interest for Actors?",
       subtitle = "Actors nominated for an Oscar or in a commercially successful movie from 2004 - 2024",
      caption = "Data Sources: The Oscar Award, 1927-2025 (aquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API),\nGoogle Trends",
      x = "", y = "Google Trend Search Interest") +
  facet_wrap(vars(type), ncol = 1) +
  theme_minimal() +
  scale_color_solarized() +
  theme(legend.position = "none")
# This is pretty interesting - suggests that generally Oscar nominated actors are have searched more but it has leveled off (could reflect trends in Google Search overall). The cyclical pattern is also interesting and I'm guessing it coincides with the ceremony and nomination announcements!

table <- joined %>% mutate(month = month(Month)) %>%
  filter(!is.na(type)) %>%
  group_by(type, month) %>%
  summarise(mean_value = mean(value)) %>%
  ungroup(month) %>%
  slice_max(order_by = mean_value, n = 3) %>%
  mutate(mean_value = round(mean_value, 1))

table %>%
  kable(caption = "Data Sources: The Oscar Award, 1927-2025 (acquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API),\nGoogle Trends",
        col.names = c("Type", "Month", "Google Trend Search Interest (mean)")) %>%
  add_header_above(c("Three Most Popular Months for Google Search Interest by Actor Type" = 3)) %>%
  kable_styling(full_width = FALSE)



```

```{r}
set.seed(90210)
wide <- trends %>%
  pivot_wider(names_from = Month, values_from = value) %>%
  tibble::column_to_rownames("name")
ts_matrix <- as.matrix(wide)

clusters <- tsclust(ts_matrix,
                    type = "partitional",
                    k = 5,  
                    distance = "sbd",
                    centroid = "shape",  # required with SBD
                    control = partitional_control(iter.max = 50),
                    seed = 90210)

cluster_assignments <- clusters@cluster  # cluster labels for each series
distances <- clusters@cldist

# Create a data frame with rownames and cluster assignment
cluster_df <- data.frame(
  name = rownames(ts_matrix),
  cluster = cluster_assignments,
  distance = distances
)

actor_with_cluster <- left_join(trends, cluster_df, by = "name") %>%
  mutate(cluster_label = case_when(
    cluster == 1 ~ paste0(cluster, "\nBlockbuster Staple"),
    cluster == 2 ~ paste0(cluster, "\nBreakout Star or Memorialized"),
    cluster == 3 ~ paste0(cluster, "\nCritically Acclaimed"),
    cluster == 4 ~ paste0(cluster, "\nPop Fame"),
    cluster == 5 ~ paste0(cluster, "\nEmerging or Consistent Stardom")
  ))

actor_with_cluster %>%
  group_by(Month, cluster_label) %>% summarise(value = mean(value)) %>%
  ggplot(aes(x = Month, y = value, colour = factor(cluster_label))) +
  geom_line(show.legend = FALSE) +
  scale_x_date(breaks = as.Date(c("2000-01-01", "2010-01-01", "2020-01-01")),
  date_labels = "%Y") +
  facet_wrap(vars(cluster_label), ncol = 5) + 
  scale_color_solarized() +
  theme_minimal() +
  labs(title = "5 Cluster Solution for Actor Google Search Trends",
       x = "", y = "Google Trend Search Interest")

centroid_matrix <- do.call(rbind, clusters@centroids)

# Create a data frame from the matrix
Time <- rep(seq.Date(from = as.Date("2004-01-01"), 
                     to = as.Date("2025-03-01"), 
                     by = "month"), 
            times = nrow(centroid_matrix))

centroid_df <- data.frame(Time = Time,
                          Cluster = rep(1:nrow(centroid_matrix), 
                          each = ncol(centroid_matrix)),
                          Value = as.vector(centroid_matrix)) %>%
  mutate(cluster_label = case_when(
    Cluster == 1 ~ paste0(Cluster, "\nBlockbuster Staple"),
    Cluster == 2 ~ paste0(Cluster, "\nBreakout Star or Memorialized"),
    Cluster == 3 ~ paste0(Cluster, "\nCritically Acclaimed"),
    Cluster == 4 ~ paste0(Cluster, "\nPop Fame"),
    Cluster == 5 ~ paste0(Cluster, "\nEmerging or Consistent Stardom")
  ))

centroid_df %>%
  ggplot(aes(x = Time, y = Value, color = factor(cluster_label))) +
    geom_line() +
    facet_wrap(~ cluster_label, ncol = 5) +
    labs(title = "Cluster Centroids", x = "Time", y = "Value", color = "Cluster") +
    theme_minimal() +
    scale_x_date(breaks = as.Date(c("2000-01-01", "2010-01-01", "2020-01-01")),
    date_labels = "%Y") +
    scale_color_solarized() +
    theme_minimal() +
    labs(title = "Cluster Centroids for Actor Google Search Trends",
         x = "", y = "Google Trend Search Interest (Normalized)") +
  theme(legend.position = "none")

actor_with_cluster <- actor_with_cluster %>% 
  mutate(cluster_label = str_replace_all(cluster_label, "\n", " - "))

table <- actor_with_cluster %>% 
  distinct(name, cluster_label, distance) %>%
  group_by(cluster_label) %>%
  slice_min(order_by = distance, n = 5) %>%
  mutate(row = row_number()) %>%         
  select(cluster_label, row, name) %>%  
  pivot_wider(names_from = cluster_label, values_from = name) %>%
  select(-row)

table %>%
  kable(caption = "Data Sources: The Oscar Award, 1927-2025 (acquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API),\nGoogle Trends") %>%
  add_header_above(c("Five Most Representative Actors in Each Cluster" = 5)) %>%
  kable_styling(full_width = FALSE)

table <- actor_with_cluster %>% distinct(name, cluster_label) %>%
  mutate(name = tolower(name)) %>%
  left_join(actors) %>%
  filter(!is.na(cluster_label)) %>%
  group_by(cluster_label) %>% mutate(total = n()) %>%
  group_by(cluster_label, nominee) %>%
  summarise(prop_nominees = round((n()/total)*100)) %>%
  filter(nominee == 1) %>% ungroup(nominee) %>% select(-nominee) %>%
  distinct()

table %>%
  kable(caption = "Data Sources: The Oscar Award, 1927-2025 (acquired from Kaggle),\nFilm and Actor Details (acquired from The Movie Database API),\nGoogle Trends",
        col.names = c("Cluster", "Percent Nominees (%)")) %>%
  add_header_above(c("What Percent of Actors in Each Cluster are Oscar Nominees?" = 2)) %>%
  kable_styling(full_width = FALSE)

```

```{r, include = FALSE}
years_seq <- 2004:2024

cluster_df <- cluster_df %>%
  distinct(name, cluster) %>%
  mutate(name = tolower(name))

features <- actors %>% 
  left_join(cluster_df, by = ("name")) %>% 
  select(name, age, gender, american, cluster)

winners <- actors %>%
  mutate(year_winner = str_remove_all(year_winner, "\\[|\\]")) %>%
  separate_rows(year_winner, sep = ",\\s*") %>%             
  mutate(year_winner = as.integer(year_winner)) %>%
  select(name, winner, year_winner)

# Cross join name and years_seq
winners_filled <- winners %>%
  # Create a data frame of all names and years
  distinct(name) %>%
  expand(name, year_winner = years_seq) %>%
  left_join(winners, by = c("name", "year_winner")) %>%
  rename(year = year_winner) %>%
  group_by(name) %>%
  mutate(
    won = ifelse(is.na(winner), "no", winner)
  ) %>%
  ungroup() %>%
  group_by(name) %>%
  mutate(
    won_previously = ifelse(lag(won != "no", default = FALSE), TRUE, FALSE)) %>%
  ungroup() %>%
  mutate(
    won_previously = ifelse(won_previously == TRUE, 1, 0)
  ) %>%
  group_by(name) %>%
  # Fill the 'nominated_previously' column down for each name
  mutate(won_previously = cummax(won_previously)) %>% 
  ungroup() %>%
  select(-won)

nominees <- actors %>%
  mutate(nominated_years = str_remove_all(nominated_years, "\\[|\\]")) %>%
  separate_rows(nominated_years, sep = ",\\s*") %>%             
  mutate(nominated_years = as.integer(nominated_years)) %>%
  select(name, nominated_years) %>%
  mutate(nominee = ifelse(!is.na(nominated_years), "yes", "no"))

nominees_filled <- nominees %>%
  # Create a data frame of all names and years
  distinct(name) %>%
  expand(name, nominated_years = years_seq) %>%
  left_join(nominees, by = c("name", "nominated_years")) %>%
  rename(year = nominated_years) %>%
  group_by(name) %>%
  mutate(
    nominated = ifelse(is.na(nominee), "no", nominee)  # Ensure no NAs in 'nominated' column
  ) %>%
  ungroup() %>%
  group_by(name) %>%
  mutate(
    nominated_previously = ifelse(lag(nominated == "yes", default = FALSE), TRUE, FALSE)
  ) %>%
  ungroup() %>%
  mutate(
    nominated_previously = as.integer(nominated_previously)
  ) %>%
  group_by(name) %>%
  # Fill the 'nominated_previously' column down for each name
  mutate(nominated_previously = cummax(nominated_previously)) %>% 
  ungroup() %>%
  select(-nominated)

winners_filled <- winners_filled %>%
  left_join(features, by = "name") %>%
  mutate(age = year - age)
prev_win <- winners_filled %>%
  select(name, year, won_previously)
nominees_filled <- nominees_filled %>%
  left_join(features, by = "name") %>%
  left_join(prev_win, by = c("name", "year")) %>%
  mutate(age = year - age)


trend_ts_data_all <- trends %>%
  mutate(year = year(Month),
         name = tolower(name)) %>%
  group_by(name, year) %>%
  arrange(Month) %>%
  summarise(
    ts_data = list(ts(value, frequency = 12)),
    var = var(value, na.rm = TRUE),
    .groups = "drop"
  )

trend_ts_data <- trend_ts_data_all %>%
  filter(!is.na(var) & var > 0) %>%
  select(-var) %>%
  filter(year != 2025)

# feature extraction + custom max spike height
trend_features_ts <- trend_ts_data %>%
  mutate(
    features = map(ts_data, ~ tsfeatures(.x)),  
    max_spike_height = map_dbl(ts_data, ~ max(.x, na.rm = TRUE))
  ) %>%
  unnest(features)


model_data <- trend_features_ts %>%
  left_join(nominees_filled, by = c("name", "year")) %>%
  mutate(
    nominee = factor(ifelse(is.na(nominee), 0, 1))  
  ) %>%
  select(-frequency, -nperiods, -seasonal_period, -diff2_acf10, -seas_acf1)

set.seed(90210)
data_split <- initial_split(model_data, prop = 0.8, strata = nominee)
train_data <- training(data_split)
test_data <- testing(data_split)

train_data <- train_data %>% select(-name, -ts_data, -year)
train_data_clean <- na.omit(train_data)

## undersampling

# Split the data into the two classes
non_nominee <- train_data_clean %>% filter(nominee == 0)
nominee <- train_data_clean %>% filter(nominee == 1)

# randomly sample from the majority class (non-nominee) to match the minority class (nominee)
# randomly sample the majority class (non-nominee) to match the minority class (nominee)

# get the same proportion of non-nominee as nominee
if (nrow(non_nominee) >= nrow(nominee)) {
  non_nominee_undersampled <- non_nominee[sample(nrow(non_nominee), nrow(nominee)), ]
  
  # combine
  balanced_data <- bind_rows(non_nominee_undersampled, nominee)
  
  # shuffle rows
  balanced_data <- balanced_data %>% sample_frac(1)
  
  # confirm
  table(balanced_data$nominee)
} else {
  stop("Not enough non-nominee rows to sample from.")
}


# combine the undersampled non-nominee with the full nominee class
balanced_data <- bind_rows(non_nominee_undersampled, nominee)

# check the new balance of classes
table(balanced_data$nominee)
balanced_data$cluster <- as.factor(balanced_data$cluster)
balanced_data$gender <- as.factor(balanced_data$gender)
balanced_data$american <- as.factor(balanced_data$american)
balanced_data$won_previously <- as.factor(balanced_data$won_previously)
balanced_data$nominated_previously <- as.factor(balanced_data$nominated_previously)

balanced_data1 <- balanced_data
balanced_data2 <- balanced_data %>% select(-age, -gender, -american, -nominated_previously, -won_previously)

# modeling all predictors 
data_split1 <- initial_split(balanced_data1, prop = 0.8, strata = nominee)
train_data1 <- training(data_split1)
test_data1 <- testing(data_split1)

rf_model1 <- randomForest(nominee ~ ., data = train_data1)

# modeling just time series predictors
data_split2 <- initial_split(balanced_data2, prop = 0.8, strata = nominee)
train_data2 <- training(data_split2)
test_data2 <- testing(data_split2)

rf_model2 <- randomForest(nominee ~ ., data = train_data2)
```


```{r}
# model summaries 

summary_df <- data.frame(
  Metric = c("Number of Trees", "Out-of-Bag Error Rate"),
  model1 = c(
    rf_model1$ntree,
    round(rf_model1$err.rate[nrow(rf_model1$err.rate), "OOB"], 4)
  ),
  model2 = c(
    rf_model2$ntree,
    round(rf_model2$err.rate[nrow(rf_model2$err.rate), "OOB"], 4)
  )
)

summary_df %>%
  kable(row.names = FALSE, col.names = c("", "Model 1 - All Predictors", "Model 2 - Time Series Predictors Only")) %>%
  add_header_above(c("Random Forest Model Comparison" = 3)) %>%
  kable_styling(full_width = FALSE)

```

```{r}
# prediction and evaluation

# Model 1
predictions1 <- predict(rf_model1, newdata = test_data1)
conf_matrix1 <- confusionMatrix(predictions1, test_data1$nominee)
accuracy1 <- round(sum(predictions1 == test_data1$nominee) / nrow(test_data1), 4)

# Model 2
predictions2 <- predict(rf_model2, newdata = test_data2)
conf_matrix2 <- confusionMatrix(predictions2, test_data2$nominee)
accuracy2 <- round(sum(predictions2 == test_data2$nominee) / nrow(test_data2), 4)


# Accuracy comparison
accuracy_table <- data.frame(
  Metric = "Accuracy",
  model1 = accuracy1,
  model2 = accuracy2
)

accuracy_table %>%
  kable(row.names = FALSE, col.names = c("", "Model 1 - All Predictors", "Model 2 - Time Series Predictors Only")) %>%
  add_header_above(c("Model Accuracy Comparison" = 3)) %>%
  kable_styling(full_width = FALSE)
```

```{r}
# evaluation metrics

metrics_df <- data.frame(
  Metric = c("Precision", "Recall", "F1 Score"),
  model1 = round(conf_matrix1$byClass[c("Precision", "Recall", "F1")], 4),
  model2 = round(conf_matrix2$byClass[c("Precision", "Recall", "F1")], 4)
)

metrics_df %>%
  kable(row.names = FALSE, col.names = c("", "Model 1 - All Predictors", "Model 2 - Time Series Predictors Only")) %>%
  add_header_above(c("Evaluation Metrics Comparison" = 3)) %>%
  kable_styling(full_width = FALSE)
```

```{r}
# confusion matrices

# Model 1
conf_matrix_caret1 <- confusionMatrix(predictions2, test_data2$nominee)
cat("Model 1 - All Predictors")
print(conf_matrix_caret1)

conf_matrix_caret2 <- confusionMatrix(predictions2, test_data2$nominee)
cat("Model 2 - Time Series Predictors Only")
print(conf_matrix_caret2)
```

```{r}
# feature importance plots

# Model 1
importance(rf_model1) %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  ggplot(aes(x = reorder(Variable, MeanDecreaseGini), y = MeanDecreaseGini)) +
  geom_col(fill = "#268bd2") +
  coord_flip() +
  labs(title = "Feature Importance of Model 1 - All Predictors", x = "", y = "Mean Decrease in Gini") +
  theme_minimal()

# Model 2
importance(rf_model2) %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  ggplot(aes(x = reorder(Variable, MeanDecreaseGini), y = MeanDecreaseGini)) +
  geom_col(fill = "#dc322f") +
  coord_flip() +
  labs(title = "Feature Importance of Model 2 - Time Series Predictors Only", x = "", y = "Mean Decrease in Gini") +
  theme_minimal()
```


